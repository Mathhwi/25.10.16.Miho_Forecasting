# 사건 분리 로직 상세 분석

## 질문
> 만약 2.34m를 넘고, 3시간 후 내려갔다가, 3시간 후 다시 올라가면  
> 두 사건은 다른 이벤트로 처리되나?

---

## ✅ 답변: **YES, 2개의 별개 사건으로 처리됨**

### 코드 분석 (247-303번 라인)

```python
# 1단계: 모든 상승 교차 감지
df['상승교차'] = (df['이전수위'] < 2.34) & (df['수위'] >= 2.34)
crossing_indices = df[df['상승교차']].index.tolist()

# 2단계: 각 교차를 독립적으로 처리
for idx in crossing_indices:
    crossing_time = df.loc[idx, '일시']
    
    # 피크 찾기 (교차 후 24h 내)
    # ...
    
    # 우발적 변동 제외
    if max_level < threshold + 0.1:  # 2.44m 미만이면 제외
        continue
    
    # 사건으로 저장
    events.append(event_info)
```

**핵심**: 
- 각 상승 교차를 **독립적으로** 감지
- **중복 제거 로직 없음**
- 단, 피크가 2.44m 이상이어야 사건으로 인정

---

## 📊 시나리오 분석

### 시나리오 1: 사용자 질문 케이스

```
수위(m)
  2.8 ┤    ╭─╮   ╭─╮
      │   ╱   ╲ ╱   ╲
  2.4 ┤  ╱     X     ╲
  2.3 ┤─╯      │      ╲─
      │        │       
      └────┬───┬───┬───► 시간
         교차1 ↓  교차2
         (0h) 3h  6h
```

**상세 데이터**:
| 시간 | 수위 | 이벤트 |
|------|------|--------|
| 0h | 2.33 → 2.35 | **교차 1** ⭐ |
| 1h | 2.50 | 상승 |
| 2h | 2.70 | 피크 1 (2.70m) |
| 3h | 2.40 → 2.30 | 하강 (교차 아님) |
| 4h | 2.25 | 계속 하강 |
| 5h | 2.28 | 상승 시작 |
| 6h | 2.30 → 2.35 | **교차 2** ⭐ |
| 7h | 2.55 | 상승 |
| 8h | 2.75 | 피크 2 (2.75m) |

**처리 결과**:
```
사건 #1:
  - 교차: 0h (2.35m)
  - 피크: 2h (2.70m)
  - 조건: 2.70 ≥ 2.44 ✅ → 사건으로 인정

사건 #2:
  - 교차: 6h (2.35m)
  - 피크: 8h (2.75m)
  - 조건: 2.75 ≥ 2.44 ✅ → 사건으로 인정
```

**결론**: **2개의 별개 사건** ✅

---

### 시나리오 2: 우발적 변동 (제외되는 케이스)

```
수위(m)
  2.4 ┤  ╭─╮   ╭─╮
  2.34┤─╯   ╲─╯   ╲─
  2.3 ┤
      └──┬───┬───┬──► 시간
       교차1 ↓ 교차2
             X
```

**상세 데이터**:
| 시간 | 수위 | 이벤트 |
|------|------|--------|
| 0h | 2.33 → 2.38 | **교차 1** |
| 1h | 2.40 | 피크 1 (2.40m) ❌ 2.44 미만! |
| 2h | 2.36 → 2.32 | 하강 |
| 3h | 2.32 → 2.36 | **교차 2** |
| 4h | 2.41 | 피크 2 (2.41m) ❌ 2.44 미만! |

**처리 결과**:
```
교차 1 감지 → 피크 2.40m < 2.44m → ❌ 제외
교차 2 감지 → 피크 2.41m < 2.44m → ❌ 제외
```

**결론**: 둘 다 우발적 변동으로 **0개 사건** ✅

---

### 시나리오 3: 실제 데이터에서 발생 가능?

```
수위(m)
  3.0 ┤    ╭───╮
      │   ╱     ╲
  2.6 ┤  ╱       ╲╭─╮
      │ ╱         X  ╲
  2.4 ┤╱          │   ╲─
  2.3 ┤           │    
      └────┬──────┬────► 시간
         교차1   교차2
                 (중복?)
```

**가능성**: 
- 큰 강우 사건 후 작은 후속 강우
- 첫 번째 사건의 하강 중 두 번째 강우 발생

**문제**: 
- 물리적으로는 **하나의 연속된 사건**일 수 있음
- 코드는 **2개의 독립 사건**으로 분리

---

## 🔍 현재 로직의 특징

### ✅ 장점

1. **명확한 정의**
   - 상승 교차 = 새로운 사건
   - 코드가 단순하고 명확

2. **우발적 변동 제거**
   - 피크 ≥ 2.44m 조건
   - 작은 진동은 걸러짐

3. **독립성 보장**
   - 각 사건이 명확히 분리됨
   - 통계 분석에 유리

### ⚠️ 단점 (잠재적 문제)

1. **물리적으로 연속된 사건 분리 가능**
   ```
   예: 태풍으로 인한 장기간 강우
   - 첫 번째 교차: 태풍 전반부
   - 하강: 일시적 약화
   - 두 번째 교차: 태풍 후반부
   → 2개 사건으로 분리되지만, 실제로는 1개의 태풍 사건
   ```

2. **시간 제약 없음**
   - 교차 간격이 6시간이든 3일이든 상관없이 분리
   - 최소 간격 기준 없음

3. **사건 통합 로직 없음**
   ```python
   # 이런 로직이 없음:
   if (교차2_시간 - 교차1_피크) < 12시간:
       # 같은 사건으로 통합
   ```

---

## 📐 실제 데이터 확인

### 26개 사건 분석

코드 실행 결과: **26개 사건 감지**

**의문**: 
- 이 중 "분리되어야 할 1개 사건이 2개로 나뉜 경우"가 있는가?
- 또는 모두 독립적인 강우 사건인가?

### 검증 방법

```python
# 사건 간 시간 간격 확인
for i in range(len(events)-1):
    gap = events[i+1]['교차시간'] - events[i]['피크시간']
    print(f"사건 #{i+1} 피크 → 사건 #{i+2} 교차: {gap.days}일 {gap.seconds//3600}시간")
```

**예상**:
- 대부분 **며칠 이상** 간격
- 짧은 간격(< 24h)이 있다면 → 검토 필요

---

## 💡 개선 가능성

### 방법 1: 최소 간격 기준 추가

```python
# 이전 사건의 피크 후 X시간 내 교차는 제외
MIN_GAP_HOURS = 48

for idx in crossing_indices:
    crossing_time = df.loc[idx, '일시']
    
    # 새로운 체크
    if len(events) > 0:
        last_peak = events[-1]['피크시간']
        gap = (crossing_time - last_peak).total_seconds() / 3600
        if gap < MIN_GAP_HOURS:
            continue  # 너무 가까우면 제외
    
    # ... 기존 로직
```

### 방법 2: 하강 확인 기준

```python
# 교차 전에 충분히 하강했는지 확인
DESCENT_THRESHOLD = 2.0  # 2.0m 이하로 떨어졌어야 함

for idx in crossing_indices:
    # 이전 24시간 최소 수위 확인
    pre_window = df[(df['일시'] >= crossing_time - 24h) & 
                    (df['일시'] < crossing_time)]
    min_before = pre_window['수위'].min()
    
    if min_before > DESCENT_THRESHOLD:
        continue  # 충분히 안 떨어졌으면 연속 사건으로 간주
```

### 방법 3: 후처리 통합

```python
# 사건 감지 후 가까운 사건 통합
def merge_close_events(events, max_gap_hours=48):
    merged = [events[0]]
    
    for i in range(1, len(events)):
        gap = (events[i]['교차시간'] - merged[-1]['피크시간']).total_seconds() / 3600
        
        if gap < max_gap_hours:
            # 통합: 더 큰 피크 선택
            if events[i]['최대수위'] > merged[-1]['최대수위']:
                merged[-1] = events[i]
        else:
            merged.append(events[i])
    
    return merged
```

---

## 🎯 현재 코드의 동작 - 최종 정리

### 질문 시나리오

```
T=0h:  2.33 → 2.35 (상승 교차)
T=3h:  2.40 → 2.30 (하강, 교차 아님)
T=6h:  2.30 → 2.35 (상승 교차)
```

### 코드 실행 과정

```
1. 상승 교차 감지:
   - T=0h: 감지 ✅
   - T=6h: 감지 ✅
   
2. 각 교차에 대해:
   
   교차 1 (T=0h):
   - 피크 찾기 (0~24h 범위)
   - 피크 ≥ 2.44m? 
     - YES → 사건 #1로 저장 ✅
     - NO → 제외
   
   교차 2 (T=6h):
   - 피크 찾기 (6~30h 범위)
   - 피크 ≥ 2.44m?
     - YES → 사건 #2로 저장 ✅
     - NO → 제외

3. 결과: 2개 사건 (중복 체크 없음)
```

### 결론

**YES, 2개의 별개 사건으로 처리됩니다.**

**조건**:
- 둘 다 피크 ≥ 2.44m 이어야 함
- 시간 간격 무관
- 중복 제거 로직 없음

---

## 📝 논문/발표 시 언급사항

### 사건 정의의 명확화

> "본 연구에서는 수위가 기준값(2.34m)을 **상승하면서 초과하는 시점**을  
> 독립 사건의 시작으로 정의하였다. 각 상승 교차는 **별개의 사건**으로 간주되며,  
> 피크 수위가 2.44m 이상인 경우만 분석 대상으로 포함하였다.  
> 
> 이 방법은 명확한 사건 분리 기준을 제공하나, 물리적으로 연속된  
> 강우 사건이 일시적으로 약화된 후 재강화되는 경우 별개 사건으로  
> 분리될 가능성이 있다."

### Discussion 포인트

- 사건 간 최소 시간 간격 기준의 필요성
- 연속 사건 통합 알고리즘의 적용 가능성
- 현재 방법론의 장단점

---

**작성일**: 2025-10-15  
**참고 코드**: `분석코드_comprehensive_data_integration_and_analysis.py` (247-303번 라인)

