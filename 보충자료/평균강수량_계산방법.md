# 평균 강수량 계산 방법 - 정정

## ⚠️ 이전 설명의 오류

**잘못된 설명**: "48시간 구간의 평균"

**정확한 설명**: **"분석 구간 전체의 평균"** (사건마다 길이 다름)

---

## ✅ 정확한 코드 분석

### 코드 (273-277번 라인)

```python
# 분석 기간: 교차 24시간 전 ~ 피크 후 24시간
event_start = crossing_time - timedelta(hours=24)
event_end = peak_time + timedelta(hours=24)

event_data = df[(df['일시'] >= event_start) & (df['일시'] <= event_end)].copy()
```

### 구간 길이 계산

```
총 길이 = event_end - event_start
       = (peak_time + 24h) - (crossing_time - 24h)
       = peak_time - crossing_time + 48h
       = (교차~피크 시간차) + 48시간
```

**중요**: `교차~피크 시간차`는 **사건마다 다름!**

---

## 📊 구체적 예시

### 사건 #3 (2017-07-09)

실제 데이터:
- **교차 시간**: 2017-07-09 15:00
- **피크 시간**: 2017-07-09 18:00
- **시간 차이**: 3시간

분석 구간:
- **시작**: 2017-07-08 15:00 (교차 24h 전)
- **종료**: 2017-07-10 18:00 (피크 24h 후)
- **총 길이**: 24 + 3 + 24 = **51시간** ✅

데이터 포인트 (1시간 간격):
- **51개** 시간 데이터 포인트

평균 계산:
```python
X̄ (금천 평균) = (x₁ + x₂ + ... + x₅₁) / 51
Ȳ (가덕 평균) = (y₁ + y₂ + ... + y₅₁) / 51
```

---

## 🔍 다른 사건들의 구간 길이

| 사건 | 교차~피크 | 구간 길이 | 데이터 포인트 |
|------|----------|----------|--------------|
| #3 | 3시간 | 51시간 | 51개 |
| #4 | 5시간 | 53시간 | 53개 |
| #18 | 7시간 | 55시간 | 55개 |
| ... | 다양 | **사건마다 다름** | **사건마다 다름** |

---

## 💡 왜 사건마다 다른가?

### 수위 반응 속도 차이

1. **빠른 반응 사건**: 교차 후 2-3시간 만에 피크
   - 구간: 약 50-51시간
   
2. **느린 반응 사건**: 교차 후 10시간 이상 뒤 피크
   - 구간: 약 58시간 이상

### 코드 로직

```python
# 피크 찾기: 교차 시점부터 다음 24시간 내 최대 수위
peak_end_time = crossing_time + timedelta(hours=24)
peak_window = df[(df['일시'] >= crossing_time) & (df['일시'] <= peak_end_time)]

max_level = peak_window['수위'].max()
peak_time = peak_window[peak_window['수위'] == max_level]['일시'].iloc[0]
```

→ **각 사건마다 실제 피크 시간이 다르므로 구간 길이도 다름**

---

## 📐 상관계수 계산

### 실제 코드 (426번 라인)

```python
features["동시_상관계수"] = event_data[['금천_강수량', '가덕_강수량']].corr().iloc[0, 1]
```

### 내부 동작

```python
# event_data는 해당 사건의 전체 분석 구간 데이터
# 예: 사건 #3의 경우 51개 행

x = event_data['금천_강수량']  # 길이 = 구간 시간 수
y = event_data['가덕_강수량']  # 길이 = 구간 시간 수

# 평균 계산
x_mean = x.mean()  # 구간 전체의 평균
y_mean = y.mean()  # 구간 전체의 평균

# 상관계수
r = Σ[(xᵢ - x_mean)(yᵢ - y_mean)] / √[Σ(xᵢ - x_mean)² · Σ(yᵢ - y_mean)²]
```

---

## ✅ 정정된 설명

### Pearson 상관계수 공식

```
         Σ[(Xi - X̄)(Yi - Ȳ)]
r = ─────────────────────────────
    √[Σ(Xi - X̄)²] × √[Σ(Yi - Ȳ)²]
```

**변수 정의**:
- **Xi**: 분석 구간 내 시각 i에서 금천 강수량
- **Yi**: 분석 구간 내 시각 i에서 가덕 강수량
- **X̄**: **분석 구간 전체**의 금천 평균 강수량 ⭐
- **Ȳ**: **분석 구간 전체**의 가덕 평균 강수량 ⭐
- **n**: 분석 구간의 시간 포인트 수 (사건마다 다름)

**분석 구간**:
- 시작: 교차 시간 - 24시간
- 종료: 피크 시간 + 24시간
- **총 길이**: 48시간 + (피크시간 - 교차시간)
- **사건마다 다름!** (예: 50~60시간)

---

## 📝 핵심 정리

### ❌ 잘못된 표현
- "48시간 구간의 평균"
- "고정된 길이"

### ✅ 올바른 표현
- **"분석 구간 전체의 평균"**
- **"교차 24h 전 ~ 피크 24h 후"**
- **"사건마다 구간 길이가 다름"**

### 💡 왜 이렇게 정의했나?

1. **물리적 의미**: 
   - 교차 전 24h: 선행 강우 영향 포함
   - 교차 ~ 피크: 수위 상승 구간
   - 피크 후 24h: 수위 하강 및 후속 영향

2. **패턴 비교**:
   - 각 사건의 전체 강우 과정을 포함
   - 사건별 특성을 완전히 반영

3. **가변 길이의 필요성**:
   - 빠른 반응 vs 느린 반응 사건
   - 각 사건의 고유한 수문학적 특성

---

## 🎯 최종 답변

**질문**: "평균 강수량은 48시간 구간의 평균인가?"

**답변**: **아닙니다!** 

정확히는:
- **"분석 구간 전체의 평균"**
- 구간 = **교차 24h 전 ~ 피크 24h 후**
- 길이 = **48h + (교차~피크 시간차)**
- 예시: 51시간, 53시간, 55시간 등 **사건마다 다름**

---

**작성일**: 2025-10-15  
**정정 이유**: 사용자 지적에 따른 정확한 코드 확인  
**참고**: `분석코드_comprehensive_data_integration_and_analysis.py` (260-277, 426번 라인)

